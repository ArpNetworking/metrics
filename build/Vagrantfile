# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure(2) do |config|
  # Base Centos7 Image
  config.vm.box = "centos/7"
  # Grafana
  config.vm.network "forwarded_port", guest: 3000, host: 8081
  # KairosDb
  config.vm.network "forwarded_port", guest: 8080, host: 8082
  # MAD
  config.vm.network "forwarded_port", guest: 7090, host: 7090

  config.vm.provider :virtualbox do |vb|
    vb.memory = "2048"
    vb.cpus = "2"
  end
  config.vm.provider :libvirt do |libvirt|
    libvirt.memory = 2048
    libvirt.cpus = 2
  end

  # NOTE:
  # - Metric Portal runs locally on port 8080
  # - Metrics Aggregator Daemon runs locally on port 7090
  # - Cluster Aggregator runs locally on ports 7065 and 7066

  # Install packages
  config.vm.provision "shell", path: "./install"

  # Configure
  config.vm.provision "file", source: "config/mad/pipelines/http_pipeline.conf", destination: "/tmp/http_pipeline.conf"
  config.vm.provision "shell", inline: "mv /tmp/http_pipeline.conf /opt/mad/config/pipelines/http_pipeline.conf"
  config.vm.provision "file", source: "config/clusteragg/hostPipeline.conf", destination: "/tmp/hostPipeline.conf"
  config.vm.provision "shell", inline: "mv /tmp/hostPipeline.conf /opt/cluster-aggregator/config/hostPipeline.conf"
  config.vm.provision "shell", inline: "sed -i 's/localhost:8080/localhost:9000/' /opt/cluster-aggregator/config/hostPipeline.conf"
  config.vm.provision "shell", inline: "sed -i 's/localhost:8082/localhost:8080/' /opt/cluster-aggregator/config/hostPipeline.conf"

  # Start the stack
  config.vm.provision "shell", path: "./start"

end
