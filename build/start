#!/bin/bash
set -x

# Setup and start services
systemctl enable scylla-server
systemctl enable kairosdb
systemctl enable grafana-server
systemctl enable mad
systemctl enable cluster-aggregator
sleep 5
systemctl start scylla-server
sleep 15
systemctl start kairosdb
sleep 5
systemctl start grafana-server
sleep 5
systemctl start mad
systemctl start cluster-aggregator


# Set up Grafana
curl -X POST --user admin:admin -H 'content-type: application/json;charset=UTF-8' -d '{"name":"Kairos","type":"grafana-kairosdb-datasource","url":"http://localhost:8080","access":"proxy","jsonData":{},"secureJsonFields":{},"isDefault":true}' http://localhost:3000/api/datasources

# Kairos dashboard
curl -X POST \
  --user admin:admin \
  http://localhost:3000/api/dashboards/db \
  -H 'content-type: application/json' \
  -d '{ "dashboard": { "annotations": { "list": [] }, "editable": true, "gnetId": null, "graphTooltip": 0, "hideControls": false, "id": null, "links": [], "rows": [ { "collapse": false, "height": "250px", "panels": [ { "aliasColors": {}, "bars": false, "dashLength": 10, "dashes": false, "datasource": null, "fill": 1, "id": 1, "legend": { "avg": false, "current": false, "max": false, "min": false, "show": true, "total": false, "values": false }, "lines": true, "linewidth": 1, "links": [], "nullPointMode": "null", "percentage": false, "pointradius": 5, "points": false, "renderer": "flot", "seriesOverrides": [], "spaceLength": 10, "span": 6, "stack": false, "steppedLine": false, "targets": [ { "alias": "ingest count", "aliasMode": "default", "downsampling": "avg", "errors": {}, "groupBy": { "timeInterval": "1s" }, "horAggregator": { "factor": "1", "percentile": "0.75", "samplingRate": "1s", "trim": "both", "unit": "millisecond" }, "metric": "kairosdb.http.ingest_count", "refId": "A" } ], "thresholds": [], "timeFrom": null, "timeShift": null, "title": "Incoming Data", "tooltip": { "shared": true, "sort": 0, "value_type": "individual" }, "type": "graph", "xaxis": { "buckets": null, "mode": "time", "name": null, "show": true, "values": [] }, "yaxes": [ { "format": "short", "label": null, "logBase": 1, "max": null, "min": null, "show": true }, { "format": "short", "label": null, "logBase": 1, "max": null, "min": null, "show": true } ] }, { "aliasColors": {}, "bars": false, "dashLength": 10, "dashes": false, "datasource": null, "fill": 1, "id": 2, "legend": { "avg": false, "current": false, "max": false, "min": false, "show": true, "total": false, "values": false }, "lines": true, "linewidth": 1, "links": [], "nullPointMode": "null", "percentage": false, "pointradius": 5, "points": false, "renderer": "flot", "seriesOverrides": [], "spaceLength": 10, "span": 6, "stack": false, "steppedLine": false, "targets": [ { "addHorizontalAggregatorMode": false, "alias": "requests", "aliasMode": "custom", "currentHorizontalAggregatorName": "count", "downsampling": "avg", "errors": {}, "groupBy": { "timeInterval": "1s" }, "hasFactor": false, "hasNothing": false, "hasPercentile": false, "hasSamplingRate": false, "hasTrim": false, "hasUnit": false, "horAggregator": { "factor": "1", "percentile": "0.75", "samplingRate": "1s", "trim": "both", "unit": "millisecond" }, "horizontalAggregators": [ { "name": "count", "sampling_rate": "1m" } ], "isAggregatorValid": true, "metric": "kairosdb.http.request_time", "refId": "A" } ], "thresholds": [], "timeFrom": null, "timeShift": null, "title": "Kairos Queries", "tooltip": { "shared": true, "sort": 0, "value_type": "individual" }, "type": "graph", "xaxis": { "buckets": null, "mode": "time", "name": null, "show": true, "values": [] }, "yaxes": [ { "format": "short", "label": null, "logBase": 1, "max": null, "min": null, "show": true }, { "format": "short", "label": null, "logBase": 1, "max": null, "min": null, "show": true } ] } ], "repeat": null, "repeatIteration": null, "repeatRowId": null, "showTitle": false, "title": "Dashboard Row", "titleSize": "h6" } ], "schemaVersion": 14, "style": "dark", "tags": [], "templating": { "list": [] }, "time": { "from": "now-3h", "to": "now" }, "timepicker": { "refresh_intervals": [ "5s", "10s", "30s", "1m", "5m", "15m", "30m", "1h", "2h", "1d" ], "time_options": [ "5m", "15m", "1h", "6h", "12h", "24h", "2d", "7d", "30d" ] }, "timezone": "browser", "title": "Kairos Health", "version": 1 } }' 

# Service dashboard
curl -X POST \
  --user admin:admin \
  http://localhost:3000/api/dashboards/db \
  -H 'content-type: application/json' \
  -d '{ "dashboard": { "annotations": { "list": [] }, "editable": true, "gnetId": null, "graphTooltip": 2, "hideControls": false, "id": null, "links": [], "rows": [ { "collapse": false, "height": "250px", "panels": [ { "aliasColors": {}, "bars": false, "dashLength": 10, "dashes": false, "datasource": null, "fill": 1, "id": 1, "legend": { "avg": false, "current": false, "max": false, "min": false, "show": true, "total": false, "values": false }, "lines": true, "linewidth": 1, "links": [], "nullPointMode": "null", "percentage": false, "pointradius": 5, "points": false, "renderer": "flot", "seriesOverrides": [], "spaceLength": 10, "span": 12, "stack": false, "steppedLine": false, "targets": [ { "addFilterTagMode": false, "addGroupByMode": false, "addHorizontalAggregatorMode": false, "alias": "$_tag_group_service", "aliasMode": "custom", "currentGroupByType": "tag", "currentHorizontalAggregatorName": "max", "currentTagKey": "service", "downsampling": "avg", "errors": {}, "groupBy": { "tagKey": "", "timeInterval": "1s" }, "groupByTags": [ "service" ], "hasFactor": false, "hasNothing": false, "hasPercentile": false, "hasSamplingRate": false, "hasTrim": false, "hasUnit": false, "horAggregator": { "factor": "1", "percentile": "0.75", "samplingRate": "1m", "trim": "both", "unit": "millisecond" }, "horizontalAggregators": [ { "name": "max", "sampling_rate": "1m" } ], "isAggregatorValid": true, "isGroupByValid": true, "isTagGroupBy": false, "isTimeGroupBy": false, "isValueGroupBy": false, "metric": "jvm/heap_memory/used", "refId": "A", "tags": {} } ], "thresholds": [], "timeFrom": null, "timeShift": null, "title": "JVM Heap Use", "tooltip": { "shared": true, "sort": 0, "value_type": "individual" }, "type": "graph", "xaxis": { "buckets": null, "mode": "time", "name": null, "show": true, "values": [] }, "yaxes": [ { "format": "bytes", "label": null, "logBase": 1, "max": null, "min": null, "show": true }, { "format": "short", "label": null, "logBase": 1, "max": null, "min": null, "show": true } ] } ], "repeat": null, "repeatIteration": null, "repeatRowId": null, "showTitle": false, "title": "Dashboard Row", "titleSize": "h6" }, { "collapse": false, "height": 250, "panels": [ { "cards": { "cardPadding": null, "cardRound": null }, "color": { "cardColor": "rgb(7, 0, 255)", "colorScale": "sqrt", "colorScheme": "interpolateBlues", "exponent": 0.2, "mode": "spectrum" }, "dataFormat": "timeseries", "heatmap": {}, "highlightCards": true, "id": 2, "links": [], "span": 12, "targets": [ { "addHorizontalAggregatorMode": false, "alias": "rest_service/POST/metrics/v1/application/request", "aliasMode": "default", "currentHorizontalAggregatorName": "merge", "downsampling": "avg", "errors": {}, "groupBy": { "timeInterval": "1s" }, "hasFactor": false, "hasNothing": false, "hasPercentile": false, "hasSamplingRate": false, "hasTrim": false, "hasUnit": false, "horAggregator": { "factor": "1", "percentile": "0.75", "samplingRate": "1m", "trim": "both", "unit": "millisecond" }, "horizontalAggregators": [ { "name": "merge", "sampling_rate": "1m" } ], "isAggregatorValid": true, "metric": "rest_service/POST/metrics/v1/application/request", "refId": "A" } ], "title": "MAD Request Latencies", "tooltip": { "show": true, "showHistogram": true }, "type": "heatmap", "xAxis": { "show": true }, "xBucketNumber": null, "xBucketSize": "1m", "yAxis": { "decimals": null, "format": "s", "logBase": 1, "max": null, "min": null, "show": true, "splitFactor": null }, "yBucketNumber": null, "yBucketSize": null } ], "repeat": null, "repeatIteration": null, "repeatRowId": null, "showTitle": false, "title": "Dashboard Row", "titleSize": "h6" } ], "schemaVersion": 14, "style": "dark", "tags": [], "templating": { "list": [] }, "time": { "from": "now-1h", "to": "now" }, "timepicker": { "refresh_intervals": [ "5s", "10s", "30s", "1m", "5m", "15m", "30m", "1h", "2h", "1d" ], "time_options": [ "5m", "15m", "1h", "6h", "12h", "24h", "2d", "7d", "30d" ] }, "timezone": "browser", "title": "Service Stats", "version": 1 } }'

exit 0
